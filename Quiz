<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>153sella ìŒì•…í•™ì› | ê³„ì´ë¦„ í€´ì¦ˆ ê²Œì„</title>
  <style>
    :root{
      --bg:#0b1020; --card:#131a33; --ink:#e9ecf5; --muted:#aab3d3; --brand:#7ac6ff; --accent:#ffd166;
      --ok:#7ae582; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,'Noto Music','Segoe UI Symbol',sans-serif;background:linear-gradient(180deg,#0b1020,#0b1428 60%,#0b1020);color:var(--ink)}
    header,footer{position:sticky;z-index:10;backdrop-filter:saturate(140%) blur(8px)}
    header{top:0;background:rgba(19,26,51,.7);border-bottom:1px solid rgba(255,255,255,.08)}
    footer{bottom:0;background:rgba(19,26,51,.7);border-top:1px solid rgba(255,255,255,.08);font-size:12px;color:var(--muted)}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .grow{flex:1 1 360px}
    .title{font-weight:800;font-size:22px;margin:0 0 8px}
    .muted{color:var(--muted)}
    .selects{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:10px}
    select,input[type="text"],input[type="month"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#0f1430;color:var(--ink)}
    button{cursor:pointer;border:0;border-radius:14px;padding:12px 16px;background:linear-gradient(90deg,#66d0ff,#8b8bff);color:#0b1020;font-weight:800;letter-spacing:.2px;box-shadow:0 6px 18px rgba(122,198,255,.35);transition:.2s}
    button:hover{transform:translateY(-1px);box-shadow:0 10px 24px rgba(122,198,255,.5)}
    button.secondary{background:#1a2145;color:var(--ink);box-shadow:none;border:1px solid rgba(255,255,255,.12)}
    button.success{background:linear-gradient(90deg,#6ee7b7,#a7f3d0);color:#132225}
    button.warn{background:linear-gradient(90deg,#ffd166,#ff9f66);color:#2a1d0b}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid rgba(255,255,255,.12);border-radius:999px;background:#111633;color:var(--muted);font-size:12px}
    .grid-answers{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
    .ans{padding:12px 8px;border-radius:12px;background:#0f1430;border:1px solid rgba(255,255,255,.12);font-weight:700;color:var(--ink)}
    .ans.correct{outline:3px solid var(--ok); color:#fff; background:#16381f}
    .ans.wrong{outline:3px solid var(--bad)}
    .hud{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .big{font-size:28px;font-weight:900;letter-spacing:.4px}
    .svgbox{width:100%;aspect-ratio:16/9;background:#0c1230;border:1px solid rgba(255,255,255,.08);border-radius:18px;display:flex;align-items:center;justify-content:center}
    .leader{width:100%;border-collapse:collapse}
    .leader th,.leader td{padding:8px 10px;border-bottom:1px dashed rgba(255,255,255,.12);text-align:left}
    .tag{font-size:11px;padding:3px 8px;border-radius:999px;background:#13204a;border:1px solid rgba(255,255,255,.12)}
    .small{font-size:12px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:16px">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:36px;height:36px;border-radius:12px;background:linear-gradient(180deg,#66d0ff,#7ac6ff 60%,#8b8bff);display:flex;align-items:center;justify-content:center;color:#0b1020;font-weight:900">153</div>
        <div>
          <div style="font-weight:900">153sella ìŒì•…í•™ì› Â· ê³„ì´ë¦„ í€´ì¦ˆ</div>
          <div class="small muted">ë¸Œëœë“œ í•™ìŠµë„êµ¬ Â· ê° í™”ë©´ í•˜ë‹¨ì— 153sella ë¡œê³  ê³ ì •</div>
        </div>
      </div>
      <div class="pill">Made for 153sella Music Academy</div>
    </div>
  </header>

  <main class="wrap" id="app">
    <!-- START SCREEN -->
    <section id="start" class="row">
      <div class="card grow">
        <h2 class="title">ì‹œì‘í•˜ê¸°</h2>
        <p class="muted">ì§€ì ì„ ì„ íƒí•˜ê³  ì´ë¦„ì„ ì…ë ¥í•œ ë’¤ ëª¨ë“œë¥¼ ê³ ë¥´ì„¸ìš”. ëª¨ë“  ë‹¨ê³„ëŠ” 10ë¬¸ì œì…ë‹ˆë‹¤.</p>
        <div class="selects" style="margin:12px 0 16px">
          <div>
            <label class="small muted">ì§€ì  ì„ íƒ</label>
            <select id="branch">
              <option>ë§¤ê³¡ì </option>
              <option>ì²œìƒì </option>
              <option>ê°•ë™ì </option>
              <option>í™”ë´‰ì </option>
              <option>ì–‘ì •ì </option>
              <option>ì²œê³¡ì </option>
              <option>ì•¼ìŒì </option>
              <option>ë¬´ê±°ì </option>
              <option>ì£¼ì´Œì </option>
              <option>ì—°ì‚°1ì </option>
            </select>
          </div>
          <div>
            <label class="small muted">ì´ë¦„</label>
            <input id="player" type="text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
          </div>
        </div>
        <div class="row" style="align-items:center">
          <div class="pill">ë‹µì•ˆ: (ë” ë‚®ì€/ë‚®ì€/ê°€ì˜¨/ë†’ì€) + ë„Â·ë ˆÂ·ë¯¸Â·íŒŒÂ·ì†”Â·ë¼Â·ì‹œ</div>
          <label style="display:flex;align-items:center;gap:8px;margin-left:auto" class="small muted">
            <input type="checkbox" id="ttsToggle"> ì •ë‹µ ìŒì„±(TTS)
          </label>
        </div>
        <div style="height:8px"></div>
        <div class="row">
          <button class="mode" data-mode="beginner">ì´ˆê¸‰ (Treble ê°€ì˜¨ë„~ë†’ì€ ë„) Â· 30ì´ˆ</button>
          <button class="mode" data-mode="inter">ì¤‘ê¸‰ (Bass ë‚®ì€ ë„~ê°€ì˜¨ë„) Â· 25ì´ˆ</button>
          <button class="mode" data-mode="advanced">ê³ ê¸‰ (Treble+Bass) Â· 20ì´ˆ</button>
          <button class="mode" data-mode="expert">ì „ë¬¸ê°€ (ì˜¤ì„  ì•ˆ) Â· 20ì´ˆ</button>
          <button class="mode" data-mode="master">ë§ˆìŠ¤í„° (ë§ì¤„) Â· 20ì´ˆ</button>
        </div>
      </div>

      <div class="card grow">
        <h3 class="title">ì§€ì ë³„ ìµœê·¼ ê¸°ë¡</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <span class="tag">ë¡œì»¬ ì €ì¥(ë¸Œë¼ìš°ì €)</span>
          <button class="secondary small" id="clearLocal">ğŸ”’ ì „ì²´ ê¸°ë¡ ì´ˆê¸°í™”</button>
          <button class="secondary small" id="exportCsv">CSV ë‚´ë³´ë‚´ê¸°</button>
        </div>
        <table class="leader" id="tableScores">
          <thead><tr><th>ë‚ ì§œ</th><th>ì§€ì </th><th>ì´ë¦„</th><th>ëª¨ë“œ</th><th>ì •ë‹µ/10</th><th>ì ìˆ˜</th><th>ì‹œê°„ë³´ë„ˆìŠ¤</th></tr></thead>
          <tbody></tbody>
        </table>

        <div style="height:14px"></div>
        <h3 class="title">ì›”ê°„ ë­í‚¹</h3>
        <div class="row" style="align-items:center">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <label class="small muted">ì›” ì„ íƒ
              <input id="monthPicker" type="month" style="margin-left:8px"/>
            </label>
            <label class="small muted">ì§€ì 
              <select id="rankBranch" style="margin-left:8px">
                <option value="ALL">ì „ì²´</option>
                <option>ë§¤ê³¡ì </option>
                <option>ì²œìƒì </option>
                <option>ê°•ë™ì </option>
                <option>í™”ë´‰ì </option>
                <option>ì–‘ì •ì </option>
                <option>ì²œê³¡ì </option>
                <option>ì•¼ìŒì </option>
                <option>ë¬´ê±°ì </option>
                <option>ì£¼ì´Œì </option>
                <option>ì—°ì‚°1ì </option>
              </select>
            </label>
          </div>
          <div style="margin-left:auto;display:flex;gap:8px">
            <button class="secondary small" id="resetMonth">ğŸ”’ ì„ íƒ ì›” ì „ì²´ ë¦¬ì…‹</button>
            <button class="secondary small" id="resetMonthBranch">ğŸ”’ ì„ íƒ ì›”Â·ì§€ì  ë¦¬ì…‹</button>
          </div>
        </div>
        <div style="height:8px"></div>
        <table class="leader" id="monthlyBoard">
          <thead><tr><th>#</th><th>ì§€ì </th><th>ì´ë¦„</th><th>ìµœê³ ì </th><th>ë¼ìš´ë“œìˆ˜</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- GAME SCREEN -->
    <section id="game" class="hidden">
      <div class="row">
        <div class="card grow">
          <div class="hud">
            <div class="pill" id="hudBranch">ì§€ì </div>
            <div class="pill" id="hudPlayer">ì´ë¦„</div>
            <div class="pill" id="hudMode">ëª¨ë“œ</div>
            <div class="pill">ë¬¸ì œ <span id="qIndex">1</span> / 10</div>
            <div class="pill">ë‚¨ì€ì‹œê°„ <span id="timer" class="big">20.0</span>s</div>
            <div class="pill">ì •ë‹µ <span id="correct">0</span></div>
          </div>
          <div style="height:12px"></div>
          <div class="svgbox">
            <svg id="staff" viewBox="0 0 800 450" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" aria-label="ì˜¤ì„ ì•…ë³´">
              <!-- draw dynamically -->
            </svg>
          </div>
          <div style="height:12px"></div>
          <div id="answers"></div>
          <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
            <button class="secondary" id="btnQuit">ê·¸ë§Œí•˜ê¸°</button>
            <button class="warn" id="btnSkip">ëª¨ë¥´ê² ì–´ìš”(ê±´ë„ˆë›°ê¸°)</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RESULT SCREEN -->
    <section id="result" class="hidden">
      <div class="card">
        <h2 class="title">ê²°ê³¼</h2>
        <p class="muted">ìˆ˜ê³ í–ˆì–´ìš”! ì•„ë˜ ê¸°ë¡ì„ ì €ì¥í–ˆì–´ìš”.</p>
        <div class="row" style="align-items:center;gap:12px">
          <div class="pill">ì§€ì : <b id="rBranch" style="margin-left:6px"></b></div>
          <div class="pill">ì´ë¦„: <b id="rPlayer" style="margin-left:6px"></b></div>
          <div class="pill">ëª¨ë“œ: <b id="rMode" style="margin-left:6px"></b></div>
          <div class="pill">ì •ë‹µ: <b id="rCorrect" style="margin-left:6px"></b> / 10</div>
          <div class="pill">ì‹œê°„ ë³´ë„ˆìŠ¤: <b id="rBonus" style="margin-left:6px"></b></div>
          <div class="pill">ì´ì : <b id="rScore" style="margin-left:6px"></b></div>
        </div>
        <div style="height:12px"></div>
        <div class="row">
          <button id="again" class="success">ê°™ì€ ëª¨ë“œë¡œ ë‹¤ì‹œ í•˜ê¸°</button>
          <button id="toStart" class="secondary">ì²˜ìŒìœ¼ë¡œ</button>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between">
      <div>Â© 153sella ìŒì•…í•™ì› Â· ê³„ì´ë¦„ í€´ì¦ˆ</div>
      <div class="small">ë¸Œëœë“œ ë…¸ì¶œ ê³ ì • ì˜ì—­ Â· í•™ì› ë‚´ í‚¤ì˜¤ìŠ¤í¬/íƒœë¸”ë¦¿/PC ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰</div>
    </div>
  </footer>

  <script>
  // ===== ì—”ì§„/ë­í‚¹/ê´€ë¦¬ì/ìë™ë¦¬ì…‹ (7ì§€ ë³´ê¸° + ë§ì¤„ ê·œì¹™ + ìë™ ì ìˆ˜) =====

  const NOTE_NAMES = ["ë„","ë ˆ","ë¯¸","íŒŒ","ì†”","ë¼","ì‹œ"]; // C D E F G A B

  // staffIndex: 0..8 = ì˜¤ì„  ë‚´ë¶€(ë¼ì¸/ì¹¸), -1 ì•„ë˜ì¹¸, -2 ì²« ì•„ë«ë§ì¤„, -3 ë‘ë²ˆì§¸ ì•„ë˜ì¹¸, -4 ë‘ë²ˆì§¸ ì•„ë«ë§ì¤„,
  // 9 ìœ„ì¹¸, 10 ì²« ìœ—ë§ì¤„, 11 ë‘ë²ˆì§¸ ìœ„ì¹¸ ...
  // Treble ê¸°ì¤€: -2 -> C4(ê°€ì˜¨ ë„), Bass ê¸°ì¤€: 3 -> C3(ë‚®ì€ ë„)
  const CLEF = {
    treble: {
      name: "ë†’ì€ìŒìë¦¬í‘œ",
      cIndex: -2,
      baseOct: 4,
      staffIndexToY(i){ const top=150,gap=18; const bottom=top+4*gap; return bottom - i*(gap/2); },
      ranges: {
        beginner:   { min: -2, max: 5 },
        advanced:   { min:  0, max: 8 },
        expert:     { min:  0, max: 8 },
        masterLow:  { min: -6, max: -1 },
        masterHigh: { min:  9, max: 16 },
      }
    },
    bass: {
      name: "ë‚®ì€ìŒìë¦¬í‘œ",
      cIndex: 3,
      baseOct: 3,
      staffIndexToY(i){ const top=150,gap=18; const bottom=top+4*gap; return bottom - i*(gap/2); },
      ranges: {
        inter:      { min:  3, max: 10 },
        advanced:   { min:  0, max:  8 },
        expert:     { min:  0, max:  8 },
        masterLow:  { min: -6, max: -1 },
        masterHigh: { min:  9, max: 16 },
      }
    }
  };

  const MODES = {
    beginner: { label: "ì´ˆê¸‰", seconds: 30, clefs:['treble'], rangeKeys:['beginner'], gen(){ return genInRange('treble','beginner'); } },
    inter:    { label: "ì¤‘ê¸‰", seconds: 25, clefs:['bass'],   rangeKeys:['inter'],    gen(){ return genInRange('bass','inter'); } },
    advanced: { label: "ê³ ê¸‰", seconds: 20, clefs:['treble','bass'], rangeKeys:['advanced'], gen(){ const c=Math.random()<0.5?'treble':'bass'; return genInRange(c,'advanced'); } },
    expert:   { label: "ì „ë¬¸ê°€", seconds: 20, clefs:['treble','bass'], rangeKeys:['expert'],   gen(){ const c=Math.random()<0.5?'treble':'bass'; return genInRange(c,'expert'); } },
    master:   { label: "ë§ˆìŠ¤í„°", seconds: 20, clefs:['treble','bass'], rangeKeys:['masterLow','masterHigh'], gen(){ const c=Math.random()<0.5?'treble':'bass'; const z=Math.random()<0.5?'masterLow':'masterHigh'; return genInRange(c,z); } },
  };

  // ===== DOM =====
  const svg = document.getElementById('staff');
  const answersBox = document.getElementById('answers');
  const qIndex = document.getElementById('qIndex');
  const correctEl = document.getElementById('correct');
  const timerEl = document.getElementById('timer');

  // ===== ìƒíƒœ =====
  const state = { mode:'beginner', branch:'ë§¤ê³¡ì ', player:'', q:0, correct:0, bonus:0, current:null, timerId:null, tLeft:0 };

  // ===== ìœ í‹¸ =====
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min }
  function mod(n,m){ return ((n%m)+m)%m }
  function nowMonthKey(d=new Date()){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
  function getMonthKeyFromISO(iso){ const d = new Date(iso); return nowMonthKey(d); }

  // ì˜¥íƒ€ë¸Œ ì ‘ë‘ì–´
  function octavePrefix(o){ if(o<=2) return 'ë” ë‚®ì€'; if(o===3) return 'ë‚®ì€'; if(o===4) return 'ê°€ì˜¨'; return 'ë†’ì€'; }

  // ===== ê³„ì´ë¦„ ì‚°ì¶œ (ì˜ˆì™¸ ì—†ëŠ” ì •í™•í•œ ê³„ì‚°) =====
  function noteInfo(clefKey, staffIndex){
    const c = CLEF[clefKey];
    const di = staffIndex - c.cIndex;         // ê¸°ì¤€ Cë¡œë¶€í„°ì˜ 7ìŒê³„ ì˜¤í”„ì…‹
    const letterIndex = mod(di,7);             // 0=C(ë„) .. 6=B(ì‹œ)
    const octave = c.baseOct + Math.floor(di/7);
    const name = NOTE_NAMES[letterIndex];
    const label = `${octavePrefix(octave)} ${name}`;
    return { name, octave, label };
  }

  // ===== ì¶œì œ =====
  function genInRange(clefKey, rangeKey){
    const clef = CLEF[clefKey];
    const r = clef.ranges[rangeKey];
    const idx = randInt(r.min, r.max);
    const info = noteInfo(clefKey, idx);
    return { clef: clefKey, staffIndex: idx, name: info.label };
  }

  // ===== ë³´ê¸° í’€ ìƒì„±(ëª¨ë“œë³„ ì „ì²´ ê°€ëŠ¥í•œ ë¼ë²¨) =====
  function allAnswerLabelsForMode(modeKey){
    const m = MODES[modeKey];
    const set = new Set();
    m.clefs.forEach(clefKey=>{
      m.rangeKeys.forEach(rk=>{
        const r = CLEF[clefKey].ranges[rk];
        for(let i=r.min; i<=r.max; i++){
          const info = noteInfo(clefKey, i);
          set.add(info.label);
        }
      });
    });
    return Array.from(set);
  }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  // ===== SVG ë Œë” =====
  function drawStaffFrame(){
    svg.innerHTML='';
    const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
    bg.setAttribute('x',0); bg.setAttribute('y',0); bg.setAttribute('width',800); bg.setAttribute('height',450);
    bg.setAttribute('rx',18); bg.setAttribute('fill','#0b1230');
    svg.appendChild(bg);

    const title = document.createElementNS('http://www.w3.org/2000/svg','text');
    title.setAttribute('x',400); title.setAttribute('y',60); title.setAttribute('text-anchor','middle');
    title.setAttribute('fill','#e9ecf5'); title.setAttribute('font-size','22'); title.setAttribute('font-weight','800');
    title.textContent = 'ì´ ìŒí‘œì˜ ê³„ì´ë¦„ì€ ë¬´ì—‡ì¼ê¹Œìš”?';
    svg.appendChild(title);

    const top = 150, gap = 18;
    for(let i=0;i<5;i++){
      const y = top + i*gap;
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1',120); line.setAttribute('x2',680); line.setAttribute('y1',y); line.setAttribute('y2',y);
      line.setAttribute('stroke','#334'); line.setAttribute('stroke-width','2');
      svg.appendChild(line);
    }
  }

  function drawClefSymbol(clefKey){
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x',100); t.setAttribute('y',200); t.setAttribute('fill','#e9ecf5');
    t.setAttribute('font-size','96'); t.setAttribute('font-family',"'Noto Music','Segoe UI Symbol',serif");
    // ğ„ (U+1D11E), ğ„¢ (U+1D122)
    t.textContent = clefKey==='treble' ? 'ğ„' : 'ğ„¢';
    svg.appendChild(t);
  }

  function staffIndexToY(clefKey, i){ return CLEF[clefKey].staffIndexToY(i); }

  // ë§ì¤„ ê°„ê²©=ì˜¤ì„  ì¹¸ ê°„ê²©(gap/2), í‘œì‹œ ê·œì¹™ ë°˜ì˜
  function drawNote(clefKey, staffIndex){
    const x = 420; 
    const y = staffIndexToY(clefKey, staffIndex);

    const note = document.createElementNS('http://www.w3.org/2000/svg','ellipse');
    note.setAttribute('cx', x); note.setAttribute('cy', y); note.setAttribute('rx', 16); note.setAttribute('ry', 12);
    note.setAttribute('fill','#e9ecf5'); note.setAttribute('stroke','#111'); note.setAttribute('stroke-width','2');
    svg.appendChild(note);

    // through=true: ì˜¨ìŒí‘œ ì •ì¤‘ì•™ì„ ë§ì¤„ì´ ì§€ë‚˜ê° / false: ìŒí‘œì™€ ê²¹ì¹˜ì§€ ì•Šê²Œ ë”± ë¶™ê²Œ(ì¡°ê¸ˆ ì§§ê²Œ)
    function addLedger(ly, through=false){
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      const pad = through ? 30 : 26;
      line.setAttribute('x1', x-pad); line.setAttribute('x2', x+pad); line.setAttribute('y1', ly); line.setAttribute('y2', ly);
      line.setAttribute('stroke','#556'); line.setAttribute('stroke-width','2');
      svg.appendChild(line);
    }

    if(staffIndex < 0){
      if(staffIndex === -1) return; // ì²« ì•„ë˜ì¹¸: ë§ì¤„ X
      if(staffIndex === -2){ addLedger(staffIndexToY(clefKey,-2), true); return; }  // ì²« ì•„ë«ë§ì¤„: ì¤‘ì•™ í†µê³¼
      if(staffIndex === -3){ addLedger(staffIndexToY(clefKey,-2), false); return; } // ë‘ë²ˆì§¸ ì•„ë˜ì¹¸: ì•ˆìª½ ë§ì¤„ë§Œ
      for(let i=-2;i>=staffIndex;i--){
        if(i%2===0){ addLedger(staffIndexToY(clefKey,i), true); }      // ë§ì¤„ ìœ„(ì§ìˆ˜): ì¤‘ì•™ í†µê³¼
        else       { addLedger(staffIndexToY(clefKey,i+1), false); i--; } // ì¹¸(í™€ìˆ˜): ì¸ì ‘ ë§ì¤„ë§Œ
      }
    } else if(staffIndex > 8){
      if(staffIndex === 9) return; // ì²« ìœ„ì¹¸: ë§ì¤„ X
      if(staffIndex === 10){ addLedger(staffIndexToY(clefKey,10), true); return; }  // ì²« ìœ—ë§ì¤„: ì¤‘ì•™ í†µê³¼
      if(staffIndex === 11){ addLedger(staffIndexToY(clefKey,10), false); return; } // ë‘ë²ˆì§¸ ìœ„ì¹¸: ì•ˆìª½ ë§ì¤„ë§Œ
      for(let i=10;i<=staffIndex;i++){
        if(i%2===0){ addLedger(staffIndexToY(clefKey,i), true); }       // ë§ì¤„ ìœ„(ì§ìˆ˜): ì¤‘ì•™ í†µê³¼
        else       { addLedger(staffIndexToY(clefKey,i-1), false); i++; } // ì¹¸(í™€ìˆ˜): ì¸ì ‘ ë§ì¤„ë§Œ
      }
    }
  }

  function renderProblem(prob){
    drawStaffFrame();
    drawClefSymbol(prob.clef);
    drawNote(prob.clef, prob.staffIndex);
    const label = document.createElementNS('http://www.w3.org/2000/svg','text');
    label.setAttribute('x',720); label.setAttribute('y',60); label.setAttribute('fill','#aab3d3'); label.setAttribute('font-size','14'); label.setAttribute('text-anchor','end');
    label.textContent = `ë¬¸ì œ ${state.q+1} / 10`;
    svg.appendChild(label);
  }

  // ===== 7ì§€ ë³´ê¸° ìƒì„± (ì •ë‹µ 1ê°œ í¬í•¨) =====
  function makeAnswerButtons(prob){
    answersBox.innerHTML='';
    const correct = prob.name;                      // "ê°€ì˜¨ ë„" ë“±
    const pool = allAnswerLabelsForMode(state.mode).filter(x => x !== correct);
    shuffle(pool);
    const distractors = pool.slice(0, 6);           // ì˜¤ë‹µ 6ê°œ
    const options = shuffle([correct, ...distractors]); // ì´ 7ê°œ

    const row = document.createElement('div');
    row.className = 'grid-answers';
    options.forEach(label=>{
      const b = document.createElement('button');
      b.className = 'ans';
      b.textContent = label;
      b.onclick = ()=> onAnswer(label);
      row.appendChild(b);
    });
    answersBox.appendChild(row);
  }

  function speak(text){
    if(!document.getElementById('ttsToggle').checked) return;
    const synth = window.speechSynthesis; if(!synth) return;
    const ut = new SpeechSynthesisUtterance(text);
    ut.lang = 'ko-KR'; ut.rate = 1.0; ut.pitch=1.0;
    synth.cancel(); synth.speak(ut);
  }

  // ===== ê²Œì„ íë¦„ =====
  function nextQuestion(){
    if(state.q>=10){ endGame(); return; }
    const prob = MODES[state.mode].gen();
    state.current = prob;
    renderProblem(prob);
    makeAnswerButtons(prob);          // â† ë§¤ ë¬¸ì œ 7ì§€ ë³´ê¸° í‘œì‹œ
    qIndex.textContent = String(state.q+1);
  }

  function onAnswer(ans){
    const correctName = state.current.name; // ì˜ˆ: "ê°€ì˜¨ ë„"
    const btns = [...document.querySelectorAll('.ans')];
    btns.forEach(b=> b.disabled=true);
    const picked = btns.find(b=> b.textContent===ans);
    const isCorrect = (ans===correctName);
    if(isCorrect){ state.correct++; speak('ì •ë‹µ! '+ans); picked?.classList.add('correct'); }
    else { speak('ì•„ì‰¬ì›Œìš”. ì •ë‹µì€ '+(correctName||'ì •ë‹µì—†ìŒ')); picked?.classList.add('wrong'); }
    correctEl.textContent = state.correct;
    setTimeout(()=>{ btns.forEach(b=> b.disabled=false); state.q++; nextQuestion(); }, 600);
  }

  function startTimer(){
    clearInterval(state.timerId);
    const total = MODES[state.mode].seconds;
    state.tLeft = total;
    timerEl.textContent = total.toFixed(1);
    const start = performance.now();
    state.timerId = setInterval(()=>{
      const elapsed = (performance.now()-start)/1000;
      const left = Math.max(0, total - elapsed);
      state.tLeft = left; timerEl.textContent = left.toFixed(1);
      if(left<=0){ clearInterval(state.timerId); endGame(); }
    }, 100);
  }

  function startGame(mode){
    state.mode = mode;
    state.branch = document.getElementById('branch').value;
    state.player = document.getElementById('player').value.trim() || 'ë¬´ëª…';
    state.q=0; state.correct=0; state.bonus=0; state.current=null;

    document.getElementById('hudBranch').textContent = 'ì§€ì : '+state.branch;
    document.getElementById('hudPlayer').textContent = 'ì´ë¦„: '+state.player;
    document.getElementById('hudMode').textContent = 'ëª¨ë“œ: '+MODES[state.mode].label;

    document.getElementById('start').classList.add('hidden');
    document.getElementById('result').classList.add('hidden');
    document.getElementById('game').classList.remove('hidden');

    drawStaffFrame(); startTimer(); nextQuestion(); // ë³´ê¸° ìƒì„±ì€ nextQuestion ë‚´ë¶€ì—ì„œ
  }

  function endGame(){
    clearInterval(state.timerId);
    const bonus = Math.round(state.tLeft*2);
    const score = state.correct*10 + bonus;
    state.bonus = bonus;
    const rec = {date:new Date().toISOString(), branch:state.branch, player:state.player, mode:MODES[state.mode].label, correct:state.correct, bonus, score};
    saveScore(rec);
    fillResult(rec);
    document.getElementById('game').classList.add('hidden');
    document.getElementById('result').classList.remove('hidden');
  }

  // ê²°ê³¼ í™”ë©´ ì±„ìš°ê¸°
  function fillResult(rec){
    document.getElementById('rBranch').textContent = rec.branch;
    document.getElementById('rPlayer').textContent = rec.player;
    document.getElementById('rMode').textContent   = rec.mode;
    document.getElementById('rCorrect').textContent= rec.correct;
    document.getElementById('rBonus').textContent  = `+${rec.bonus}`;
    document.getElementById('rScore').textContent  = rec.correct*10 + rec.bonus;
  }

  // ===== ê¸°ë¡/ë­í‚¹ (localStorage) + ê´€ë¦¬ì =====
  const KEY='sella_note_quiz_scores_v3';
  const LAST_RESET_KEY='sella_note_quiz_last_reset_month';
  const ADMIN_PIN='0000';
  let isAdmin=false;
  function withAdmin(action){ if(isAdmin){ action(); return; } const pin=prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸(4ìë¦¬)ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); if(pin===null) return; if(pin===ADMIN_PIN){ isAdmin=true; action(); } else alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }

  function loadScores(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(e){ return []; } }
  function saveScore(s){ const arr = loadScores(); arr.unshift(s); localStorage.setItem(KEY, JSON.stringify(arr.slice(0,500))); renderScores(); renderMonthlyBoard(); }

  function renderScores(){
    const arr = loadScores();
    const tbody = document.querySelector('#tableScores tbody');
    if(!tbody) return;
    tbody.innerHTML='';
    arr.slice(0,20).forEach(r=>{
      const d = new Date(r.date);
      const ds = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${ds}</td><td>${r.branch}</td><td>${r.player}</td><td>${r.mode}</td><td>${r.correct}</td><td>${r.score}</td><td>+${r.bonus}</td>`;
      tbody.appendChild(tr);
    })
  }

  function renderMonthlyBoard(){
    const monthEl = document.getElementById('monthPicker');
    const branchEl = document.getElementById('rankBranch');
    if(!monthEl) return;
    const monthKey = monthEl.value || nowMonthKey();
    const branchFilter = branchEl.value || 'ALL';

    const arr = loadScores().filter(r => getMonthKeyFromISO(r.date) === monthKey);
    const filtered = branchFilter==='ALL' ? arr : arr.filter(r=> r.branch === branchFilter);

    const map = new Map();
    filtered.forEach(r=>{
      const key = `${r.branch}|${r.player}`;
      if(!map.has(key)){ map.set(key, {branch:r.branch, player:r.player, best:r.score, rounds:1}); }
      else{ const g = map.get(key); g.best = Math.max(g.best, r.score); g.rounds += 1; }
    });

    const rows = [...map.values()].sort((a,b)=> b.best - a.best).slice(0,20);
    const tbody = document.querySelector('#monthlyBoard tbody');
    if(!tbody) return;
    tbody.innerHTML='';
    rows.forEach((g,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${g.branch}</td><td>${g.player}</td><td>${g.best}</td><td>${g.rounds}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ì›” ë¦¬ì…‹
  function resetMonthData(monthKey){
    const arr = loadScores();
    const next = arr.filter(r => getMonthKeyFromISO(r.date) !== monthKey);
    localStorage.setItem(KEY, JSON.stringify(next));
    localStorage.setItem(LAST_RESET_KEY, monthKey);
    renderScores(); renderMonthlyBoard();
  }
  function resetMonthAll(){
    const monthEl=document.getElementById('monthPicker');
    const monthKey = monthEl.value || nowMonthKey();
    resetMonthData(monthKey);
    alert(`${monthKey} ì›” ê¸°ë¡ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
  }
  function resetMonthBranch(){
    const monthEl=document.getElementById('monthPicker');
    const branchEl=document.getElementById('rankBranch');
    const monthKey=monthEl.value || nowMonthKey();
    const branch=branchEl.value;
    if(branch==='ALL'){ alert('ì§€ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”. (ì›” ì „ì²´ ë¦¬ì…‹ì€ ì¢Œì¸¡ ë²„íŠ¼ ì‚¬ìš©)'); return; }
    const arr=loadScores();
    const next=arr.filter(r=> !(getMonthKeyFromISO(r.date)===monthKey && r.branch===branch));
    localStorage.setItem(KEY, JSON.stringify(next));
    renderScores(); renderMonthlyBoard();
    alert(`${monthKey} ì›” ${branch} ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
  }

  // ìë™ ë¦¬ì…‹ ìŠ¤ì¼€ì¤„ëŸ¬ (ë§¤ì›” 1ì¼ 00:00)
  function scheduleNextMonthlyReset(){
    const now=new Date(); const y=now.getFullYear(); const m=now.getMonth();
    const next=(m===11)? new Date(y+1,0,1,0,0,0,0) : new Date(y,m+1,1,0,0,0,0);
    const ms=next-now;
    setTimeout(()=>{
      const currentMonth = nowMonthKey(new Date());
      resetMonthData(currentMonth);
      scheduleNextMonthlyReset();
    }, ms);
  }
  function ensureMonthlyResetOnStartup(){
    const current=nowMonthKey();
    const last=localStorage.getItem(LAST_RESET_KEY);
    if(last!==current){ resetMonthData(current); }
  }

  // ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© =====
  document.querySelectorAll('.mode').forEach(btn=> btn.addEventListener('click',()=> startGame(btn.dataset.mode)));
  document.getElementById('btnQuit').onclick=()=>{ clearInterval(state.timerId); showStart(); };
  document.getElementById('btnSkip').onclick=()=>{ state.q++; nextQuestion(); };
  document.getElementById('again').onclick=()=> startGame(state.mode);
  document.getElementById('toStart').onclick=()=> showStart();

  // CSV ë‚´ë³´ë‚´ê¸°
  document.getElementById('exportCsv').onclick = () => {
    const arr = loadScores();
    const header = ['date','branch','player','mode','correct','bonus','score'];
    const esc = (v) => `"${String(v).replace(/"/g, '""')}"`;
    const lines = [ header.join(','), ...arr.map(r => header.map(h => esc(r[h])).join(',')) ];
    const blob = new Blob(["\uFEFF" + lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = '153sella_note_quiz_scores.csv'; a.click();
    URL.revokeObjectURL(url);
  };

  document.getElementById('clearLocal').onclick=()=> withAdmin(()=>{ localStorage.removeItem(KEY); renderScores(); renderMonthlyBoard(); alert('ì „ì²´ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); });
  document.getElementById('resetMonth').onclick = ()=> withAdmin(resetMonthAll);
  document.getElementById('resetMonthBranch').onclick = ()=> withAdmin(resetMonthBranch);
  document.getElementById('monthPicker').onchange = renderMonthlyBoard;
  document.getElementById('rankBranch').onchange = renderMonthlyBoard;

  function showStart(){
    document.getElementById('result').classList.add('hidden');
    document.getElementById('game').classList.add('hidden');
    document.getElementById('start').classList.remove('hidden');
    renderScores();
    renderMonthlyBoard();
  }

  // ì´ˆê¸°í™”
  (function init(){
    const m=nowMonthKey();
    const monthEl=document.getElementById('monthPicker');
    if(monthEl) monthEl.value=m;
    renderScores(); renderMonthlyBoard(); drawStaffFrame();
    ensureMonthlyResetOnStartup();
    scheduleNextMonthlyReset();
    window.addEventListener('focus', ensureMonthlyResetOnStartup);
  })();
  </script>
</body>
</html>
