<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>153sella ìŒì•…í•™ì› | ê³„ì´ë¦„ í€´ì¦ˆ ê²Œì„</title>
  <style>
    :root{
      --bg:#0b1020; --card:#131a33; --ink:#e9ecf5; --muted:#aab3d3; --brand:#7ac6ff; --accent:#ffd166;
      --ok:#7ae582; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,'Noto Music','Segoe UI Symbol',sans-serif;background:linear-gradient(180deg,#0b1020,#0b1428 60%,#0b1020);color:var(--ink)}
    header,footer{position:sticky;z-index:10;backdrop-filter:saturate(140%) blur(8px)}
    header{top:0;background:rgba(19,26,51,.7);border-bottom:1px solid rgba(255,255,255,.08)}
    footer{bottom:0;background:rgba(19,26,51,.7);border-top:1px solid rgba(255,255,255,.08);font-size:12px;color:var(--muted)}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .grow{flex:1 1 360px}
    .title{font-weight:800;font-size:22px;margin:0 0 8px}
    .muted{color:var(--muted)}
    .selects{display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:10px}
    select,input[type="text"],input[type="month"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#0f1430;color:var(--ink)}
    button{cursor:pointer;border:0;border-radius:14px;padding:12px 16px;background:linear-gradient(90deg,#66d0ff,#8b8bff);color:#0b1020;font-weight:800;letter-spacing:.2px;box-shadow:0 6px 18px rgba(122,198,255,.35);transition:.2s}
    button:hover{transform:translateY(-1px);box-shadow:0 10px 24px rgba(122,198,255,.5)}
    button.secondary{background:#1a2145;color:var(--ink);box-shadow:none;border:1px solid rgba(255,255,255,.12)}
    button.success{background:linear-gradient(90deg,#6ee7b7,#a7f3d0);color:#132225}
    button.warn{background:linear-gradient(90deg,#ffd166,#ff9f66);color:#2a1d0b}
        .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid rgba(255,255,255,.12);border-radius:999px;background:#111633;color:var(--muted);font-size:12px}
    .answer-groups{display:flex;flex-direction:column;gap:8px}
    .grid-answers{display:grid;grid-template-columns:repeat(8,1fr);gap:10px}
    .ans{padding:12px 8px;border-radius:12px;background:#0f1430;border:1px solid rgba(255,255,255,.12);font-weight:700;color:var(--ink)}
    .ans.correct{outline:3px solid var(--ok); color:#fff; background:#16381f}
    .ans.wrong{outline:3px solid var(--bad)}
    .hud{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .big{font-size:28px;font-weight:900;letter-spacing:.4px}
    .svgbox{width:100%;aspect-ratio:16/9;background:#0c1230;border:1px solid rgba(255,255,255,.08);border-radius:18px;display:flex;align-items:center;justify-content:center}
    .leader{width:100%;border-collapse:collapse}
    .leader th,.leader td{padding:8px 10px;border-bottom:1px dashed rgba(255,255,255,.12);text-align:left}
    .tag{font-size:11px;padding:3px 8px;border-radius:999px;background:#13204a;border:1px solid rgba(255,255,255,.12)}
    .small{font-size:12px}
    .hidden{display:none}

    /* ===== ìƒˆë¡œìš´ ë‹¨ê³„ë³„ ë””ìì¸ ìŠ¤íƒ€ì¼ ===== */
    .main-screen {
      text-align: center;
      padding: 40px 20px;
    }
    
    .main-title h1 {
      font-size: 3rem;
      font-weight: 900;
      background: linear-gradient(135deg, #7ac6ff, #8b8bff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 16px;
    }
    
    .main-title p {
      font-size: 1.2rem;
      color: var(--muted);
      margin-bottom: 60px;
    }
    
    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 60px;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .feature-card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 20px;
      padding: 32px 24px;
      text-align: center;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .feature-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0,0,0,.3);
    }
    
    .feature-icon {
      font-size: 3rem;
      margin-bottom: 20px;
    }
    
    .feature-card h3 {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--ink);
    }
    
    .feature-card p {
      color: var(--muted);
      line-height: 1.5;
    }
    
    .start-btn {
      background: linear-gradient(135deg, #7ac6ff, #8b8bff);
      color: #0b1020;
      font-size: 1.2rem;
      font-weight: 800;
      padding: 20px 40px;
      border-radius: 50px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 10px 30px rgba(122,198,255,.4);
    }
    
    .start-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(122,198,255,.6);
    }
    
    .start-btn span:first-child {
      font-size: 1.5rem;
    }
    
    /* ì‚¬ìš©ì ì •ë³´ ì…ë ¥ í™”ë©´ */
    .back-btn {
      background: #2a2a2a;
      color: var(--ink);
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-bottom: 40px;
      transition: background 0.3s ease;
    }
    
    .back-btn:hover {
      background: #3a3a3a;
    }
    
    .user-info-card {
      background: white;
      border-radius: 24px;
      padding: 48px;
      max-width: 500px;
      margin: 0 auto 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,.1);
      text-align: center;
    }
    
    .user-icon {
      font-size: 4rem;
      margin-bottom: 24px;
      color: #7ac6ff;
    }
    
    .user-info-card h2 {
      color: #333;
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 12px;
    }
    
    .user-info-card p {
      color: #666;
      margin-bottom: 32px;
    }
    
    .input-group {
      text-align: left;
      margin-bottom: 24px;
    }
    
    .input-group label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 1rem;
    }
    
    .input-desc {
      color: #888 !important;
      font-size: 0.9rem !important;
      margin: 4px 0 8px !important;
      text-align: left !important;
    }
    
    .input-group select,
    .input-group input[type="text"] {
      width: 100%;
      padding: 16px;
      border: 2px solid #e1e5e9;
      border-radius: 12px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
      background: white;
      color: #333;
    }
    
    .input-group select:focus,
    .input-group input[type="text"]:focus {
      outline: none;
      border-color: #7ac6ff;
    }
    
    .checkbox-label {
      display: flex !important;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      color: #333 !important;
      font-weight: 600 !important;
    }
    
    .checkbox-label input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #7ac6ff;
    }
    
    .next-btn {
      background: linear-gradient(135deg, #7ac6ff, #8b8bff);
      color: white;
      border: none;
      padding: 18px 36px;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 16px;
    }
    
    .next-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(122,198,255,.4);
    }
    
    .info-tips {
      max-width: 500px;
      margin: 0 auto;
    }
    
    .tip {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: rgba(255,255,255,.05);
      border-radius: 12px;
      margin-bottom: 12px;
      color: var(--muted);
    }
    
    .tip-icon {
      font-size: 1.2rem;
    }
    
    /* ê²Œì„ ëª¨ë“œ ì„ íƒ í™”ë©´ */
    .mode-title {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .mode-title h2 {
      font-size: 2.2rem;
      font-weight: 800;
      margin-bottom: 12px;
      color: var(--ink);
    }
    
    .mode-title p {
      color: var(--muted);
      font-size: 1.1rem;
    }
    
    .modes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .modes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .mode-card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 20px;
      padding: 32px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .mode-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0,0,0,.3);
      border-color: rgba(122,198,255,.3);
    }
    
    .mode-icon {
      font-size: 2.5rem;
      margin-bottom: 20px;
    }
    
    .mode-card h3 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--ink);
    }
    
    .difficulty {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 800;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
      text-transform: uppercase;
    }
    
    .difficulty.beginner { background: #4ade80; color: #064e3b; }
    .difficulty.intermediate { background: #60a5fa; color: #1e3a8a; }
    .difficulty.advanced { background: #fbbf24; color: #78350f; }
    .difficulty.expert { background: #f97316; color: #7c2d12; }
    .difficulty.master { background: #ef4444; color: #7f1d1d; }
    
    .mode-desc {
      color: var(--muted);
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .mode-details {
      margin-bottom: 20px;
    }
    
    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,.1);
    }
    
    .detail-item:last-child {
      border-bottom: none;
    }
    
    .detail-label {
      color: var(--muted);
      font-size: 0.9rem;
    }
    
    .detail-value {
      color: var(--ink);
      font-weight: 600;
    }
    
    .mode-tip {
      background: rgba(122,198,255,.1);
      border: 1px solid rgba(122,198,255,.2);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    
    .tip-label {
      color: #7ac6ff;
      font-weight: 700;
      margin-right: 8px;
    }
    
    .mode-tip span:last-child {
      color: var(--ink);
    }
    
    /* ì ìˆ˜ í™”ë©´ */
    .scores-container {
      max-width: 1000px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:16px">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:36px;height:36px;border-radius:12px;background:linear-gradient(180deg,#66d0ff,#7ac6ff 60%,#8b8bff);display:flex;align-items:center;justify-content:center;color:#0b1020;font-weight:900">153</div>
        <div>
          <div style="font-weight:900">153sella ìŒì•…í•™ì› Â· ê³„ì´ë¦„ í€´ì¦ˆ</div>
          <div class="small muted">ë¸Œëœë“œ í•™ìŠµë„êµ¬ Â· ê° í™”ë©´ í•˜ë‹¨ì— 153sella ë¡œê³  ê³ ì •</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <button id="showScores" class="secondary small">ğŸ“Š ì ìˆ˜ ë³´ê¸°</button>
        <div class="pill">Made for 153sella Music Academy</div>
      </div>
    </div>
  </header>

  <main class="wrap" id="app">
    <!-- INTRO (1/3) -->
    <section id="intro" class="row">
      <div class="card grow">
        <h2 class="title">ì‹œì‘í•˜ê¸°</h2>
        <p class="muted">ì§€ì ì„ ì„ íƒí•˜ê³  ì´ë¦„ì„ ì…ë ¥í•œ ë’¤ ê²Œì„ ëª¨ë“œë¥¼ ê³ ë¥´ì„¸ìš”. ëª¨ë“  ë‹¨ê³„ëŠ” 10ë¬¸ì œì…ë‹ˆë‹¤.</p>
        <div class="selects" style="margin:12px 0 16px">
          <div>
            <label class="small muted">ì§€ì  ì„ íƒ</label>
            <select id="branch">
              <option>ë§¤ê³¡ì </option>
              <option>ì²œìƒì </option>
              <option>ê°•ë™ì </option>
              <option>í™”ë´‰ì </option>
              <option>ì–‘ì •ì </option>
              <option>ì²œê³¡ì </option>
              <option>ì•¼ìŒì </option>
              <option>ë¬´ê±°ì </option>
              <option>ì£¼ì´Œì </option>
              <option>ì—°ì‚°1ì </option>
            </select>
          </div>
          <div>
            <label class="small muted">ì´ë¦„</label>
            <input id="player" type="text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
          </div>
        </div>
        <div class="row" style="align-items:center">
          <div class="pill">ë‹µì•ˆ: (ë” ë‚®ì€/ë‚®ì€/ê°€ì˜¨/ë†’ì€) + ë„Â·ë ˆÂ·ë¯¸Â·íŒŒÂ·ì†”Â·ë¼Â·ì‹œ</div>
          <label style="display:flex;align-items:center;gap:8px;margin-left:auto" class="small muted">
            <input type="checkbox" id="ttsToggle" checked> ì •ë‹µ ìŒì„±(TTS)
          </label>
        </div>
        <div style="height:8px"></div>
        <button id="goMode" class="next-btn">ğŸ® ê²Œì„ ëª¨ë“œ ì„ íƒí•˜ê¸°</button>
      </div>

      <div class="card grow">
        <h3 class="title">ì§€ì ë³„ ìµœê·¼ ê¸°ë¡</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <span class="tag">ë¡œì»¬ ì €ì¥(ë¸Œë¼ìš°ì €)</span>
          <button class="secondary small" id="clearLocal">ğŸ”’ ì „ì²´ ê¸°ë¡ ì´ˆê¸°í™”</button>
          <button class="secondary small" id="exportCsv">CSV ë‚´ë³´ë‚´ê¸°</button>
        </div>
        <table class="leader" id="tableScores">
          <thead><tr><th>ë‚ ì§œ</th><th>ì§€ì </th><th>ì´ë¦„</th><th>ëª¨ë“œ</th><th>ì •ë‹µ/10</th><th>ì ìˆ˜</th><th>ì‹œê°„ë³´ë„ˆìŠ¤</th></tr></thead>
          <tbody></tbody>
        </table>

        <div style="height:14px"></div>
        <h3 class="title">ì›”ê°„ ë­í‚¹</h3>
        <div class="row" style="align-items:center">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <label class="small muted">ì›” ì„ íƒ
              <input id="monthPicker" type="month" style="margin-left:8px"/>
            </label>
            <label class="small muted">ì§€ì 
              <select id="rankBranch" style="margin-left:8px">
                <option value="ALL">ì „ì²´</option>
                <option>ë§¤ê³¡ì </option>
                <option>ì²œìƒì </option>
                <option>ê°•ë™ì </option>
                <option>í™”ë´‰ì </option>
                <option>ì–‘ì •ì </option>
                <option>ì²œê³¡ì </option>
                <option>ì•¼ìŒì </option>
                <option>ë¬´ê±°ì </option>
                <option>ì£¼ì´Œì </option>
                <option>ì—°ì‚°1ì </option>
              </select>
            </label>
          </div>
          <div style="margin-left:auto;display:flex;gap:8px">
            <button class="secondary small" id="resetMonth">ğŸ”’ ì„ íƒ ì›” ì „ì²´ ë¦¬ì…‹</button>
            <button class="secondary small" id="resetMonthBranch">ğŸ”’ ì„ íƒ ì›”Â·ì§€ì  ë¦¬ì…‹</button>
          </div>
        </div>
        <div style="height:8px"></div>
        <table class="leader" id="monthlyBoard">
          <thead><tr><th>#</th><th>ì§€ì </th><th>ì´ë¦„</th><th>ìµœê³ ì </th><th>ë¼ìš´ë“œìˆ˜</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>



    <!-- MODE SELECT (3/3) -->
    <section id="mode" class="hidden">
      <div class="card">
        <button id="backToIntro" class="secondary" style="margin-bottom:16px">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        <h2 class="title">ê²Œì„ ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
        <p class="muted">ë‚œì´ë„ì— ë”°ë¼ ë‹¤ë¥¸ ìŒì—­ëŒ€ì™€ ì‹œê°„ ì œí•œì´ ì ìš©ë©ë‹ˆë‹¤</p>
        <div class="modes">
          <div class="mode-card">
            <h3>ì´ˆê¸‰ <span class="pill">BEGINNER</span></h3>
            <div class="muted">ë†’ì€ìŒìë¦¬í‘œ, ê°€ì˜¨ë„~ë†’ì€ë„ / 30ì´ˆ / 10ë¬¸ì œ</div>
            <div style="height:8px"></div>
            <button class="mode" data-mode="beginner">ì‹œì‘</button>
          </div>
          <div class="mode-card">
            <h3>ì¤‘ê¸‰ <span class="pill">INTERMEDIATE</span></h3>
            <div class="muted">ë‚®ì€ìŒìë¦¬í‘œ, ë‚®ì€ë„~ê°€ì˜¨ë„ / 25ì´ˆ / 10ë¬¸ì œ</div>
            <div style="height:8px"></div>
            <button class="mode" data-mode="inter">ì‹œì‘</button>
          </div>
          <div class="mode-card">
            <h3>ê³ ê¸‰ <span class="pill">ADVANCED</span></h3>
            <div class="muted">Treble+Bass(ì˜¤ì„  ë‚´ë¶€) / 20ì´ˆ / 10ë¬¸ì œ</div>
            <div style="height:8px"></div>
            <button class="mode" data-mode="advanced">ì‹œì‘</button>
          </div>
          <div class="mode-card">
            <h3>ì „ë¬¸ê°€ <span class="pill">EXPERT</span></h3>
            <div class="muted">ë‘ ìŒìë¦¬í‘œ(ì˜¤ì„  ë‚´ë¶€) / 20ì´ˆ / 10ë¬¸ì œ</div>
            <div style="height:8px"></div>
            <button class="mode" data-mode="expert">ì‹œì‘</button>
          </div>
          <div class="mode-card">
            <h3>ë§ˆìŠ¤í„° <span class="pill">MASTER</span></h3>
            <div class="muted">ë§ì¤„ ì˜ì—­ ëœë¤ / 20ì´ˆ / 10ë¬¸ì œ</div>
            <div style="height:8px"></div>
            <button class="mode" data-mode="master">ì‹œì‘</button>
          </div>
        </div>
      </div>
    </section>

    <!-- SCORES SCREEN -->
    <section id="scores" class="hidden">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
          <h2 class="title">ğŸ“Š ì ìˆ˜ ê¸°ë¡ ë° ë­í‚¹</h2>
          <div style="display:flex;gap:8px">
            <button id="backToIntroFromScores" class="secondary">â† ë©”ì¸ìœ¼ë¡œ</button>
            <button id="backToModeFromScores" class="secondary">â† ê²Œì„ ëª¨ë“œë¡œ</button>
          </div>
        </div>
        
        <h3 class="title">ì§€ì ë³„ ìµœê·¼ ê¸°ë¡</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <span class="tag">ë¡œì»¬ ì €ì¥(ë¸Œë¼ìš°ì €)</span>
          <button class="secondary small" id="clearLocal">ğŸ”’ ì „ì²´ ê¸°ë¡ ì´ˆê¸°í™”</button>
          <button class="secondary small" id="exportCsv">CSV ë‚´ë³´ë‚´ê¸°</button>
        </div>
        <table class="leader" id="tableScores">
          <thead><tr><th>ë‚ ì§œ</th><th>ì§€ì </th><th>ì´ë¦„</th><th>ëª¨ë“œ</th><th>ì •ë‹µ/10</th><th>ì ìˆ˜</th><th>ì‹œê°„ë³´ë„ˆìŠ¤</th></tr></thead>
          <tbody></tbody>
        </table>

        <div style="height:14px"></div>
        <h3 class="title">ì›”ê°„ ë­í‚¹</h3>
        <div class="row" style="align-items:center">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <label class="small muted">ì›” ì„ íƒ
              <input id="monthPicker" type="month" style="margin-left:8px"/>
            </label>
            <label class="small muted">ì§€ì 
              <select id="rankBranch" style="margin-left:8px">
                <option value="ALL">ì „ì²´</option>
                <option>ë§¤ê³¡ì </option><option>ì²œìƒì </option><option>ê°•ë™ì </option><option>í™”ë´‰ì </option><option>ì–‘ì •ì </option><option>ì²œê³¡ì </option><option>ì•¼ìŒì </option><option>ë¬´ê±°ì </option><option>ì£¼ì´Œì </option><option>ì—°ì‚°1ì </option>
              </select>
            </label>
          </div>
          <div style="margin-left:auto;display:flex;gap:8px">
            <button class="secondary small" id="resetMonth">ğŸ”’ ì„ íƒ ì›” ì „ì²´ ë¦¬ì…‹</button>
            <button class="secondary small" id="resetMonthBranch">ğŸ”’ ì„ íƒ ì›”Â·ì§€ì  ë¦¬ì…‹</button>
          </div>
        </div>
        <div style="height:8px"></div>
        <table class="leader" id="monthlyBoard">
          <thead><tr><th>#</th><th>ì§€ì </th><th>ì´ë¦„</th><th>ìµœê³ ì </th><th>ë¼ìš´ë“œìˆ˜</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- GAME SCREEN -->
    <section id="game" class="hidden">
      <div class="row">
        <div class="card grow">
          <div class="hud">
            <div class="pill" id="hudBranch">ì§€ì </div>
            <div class="pill" id="hudPlayer">ì´ë¦„</div>
            <div class="pill" id="hudMode">ëª¨ë“œ</div>
            <div class="pill">ë¬¸ì œ <span id="qIndex">1</span> / 10</div>
            <div class="pill">ë‚¨ì€ì‹œê°„ <span id="timer" class="big">20.0</span>s</div>
            <div class="pill">ì •ë‹µ <span id="correct">0</span></div>
          </div>
          <div style="height:12px"></div>
          <div class="svgbox">
            <svg id="staff" viewBox="0 0 800 450" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" aria-label="ì˜¤ì„ ì•…ë³´">
              <!-- draw dynamically -->
            </svg>
          </div>
          <div style="height:12px"></div>
          <div class="answer-groups" id="answers"></div>
          <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
            <button class="secondary" id="btnQuit">ê·¸ë§Œí•˜ê¸°</button>
            <button class="warn" id="btnSkip">ëª¨ë¥´ê² ì–´ìš”(ê±´ë„ˆë›°ê¸°)</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RESULT SCREEN -->
    <section id="result" class="hidden">
      <div class="card">
        <h2 class="title">ê²°ê³¼</h2>
        <p class="muted">ìˆ˜ê³ í–ˆì–´ìš”! ì•„ë˜ ê¸°ë¡ì„ ì €ì¥í–ˆì–´ìš”.</p>
        <div class="row" style="align-items:center;gap:12px">
          <div class="pill">ì§€ì : <b id="rBranch" style="margin-left:6px"></b></div>
          <div class="pill">ì´ë¦„: <b id="rPlayer" style="margin-left:6px"></b></div>
          <div class="pill">ëª¨ë“œ: <b id="rMode" style="margin-left:6px"></b></div>
          <div class="pill">ì •ë‹µ: <b id="rCorrect" style="margin-left:6px"></b> / 10</div>
          <div class="pill">ì‹œê°„ ë³´ë„ˆìŠ¤: <b id="rBonus" style="margin-left:6px"></b></div>
          <div class="pill">ì´ì : <b id="rScore" style="margin-left:6px"></b></div>
        </div>
        <div style="height:12px"></div>
        <div class="row">
          <button id="again" class="success">ê°™ì€ ëª¨ë“œë¡œ ë‹¤ì‹œ í•˜ê¸°</button>
          <button id="toMode" class="secondary">ëª¨ë“œ ì„ íƒìœ¼ë¡œ</button>
          <button id="toIntro" class="secondary">ë©”ì¸ìœ¼ë¡œ</button>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between">
      <div>Â© 153sella ìŒì•…í•™ì› Â· ê³„ì´ë¦„ í€´ì¦ˆ</div>
      <div class="small">ë¸Œëœë“œ ë…¸ì¶œ ê³ ì • ì˜ì—­ Â· í•™ì› ë‚´ í‚¤ì˜¤ìŠ¤í¬/íƒœë¸”ë¦¿/PC ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰</div>
    </div>
  </footer>

  <script>
  // ===== ì—”ì§„/ë­í‚¹/ê´€ë¦¬ì/ìë™ë¦¬ì…‹ (7ì§€ ë³´ê¸° + ë§ì¤„ ê·œì¹™ + ìë™ ì ìˆ˜) =====

  const NOTE_NAMES = ["ë„","ë ˆ","ë¯¸","íŒŒ","ì†”","ë¼","ì‹œ"]; // C D E F G A B

  // staffIndex: 0..8 = ì˜¤ì„  ë‚´ë¶€(ë¼ì¸/ì¹¸), -1 ì•„ë˜ì¹¸, -2 ì²« ì•„ë«ë§ì¤„, -3 ë‘ë²ˆì§¸ ì•„ë˜ì¹¸, -4 ë‘ë²ˆì§¸ ì•„ë«ë§ì¤„,
  // 9 ìœ„ì¹¸, 10 ì²« ìœ—ë§ì¤„, 11 ë‘ë²ˆì§¸ ìœ„ì¹¸ ...
  // Treble ê¸°ì¤€: -2 -> C4(ê°€ì˜¨ ë„), Bass ê¸°ì¤€: 3 -> C3(ë‚®ì€ ë„)
  const CLEF = {
    treble: {
      name: "ë†’ì€ìŒìë¦¬í‘œ",
      cIndex: -2,  // C4 index
      baseOct: 4,
      staffIndexToY(i){ const top=150,gap=18; const bottom=top+4*gap; return bottom - i*(gap/2); },
      ranges: {
        beginner:   { min: -2, max: 5 },
        advanced:   { min:  0, max: 8 },
        expert:     { min:  0, max: 8 },
        masterLow:  { min: -6, max: -1 },
        masterHigh: { min:  9, max: 16 },
      }
    },
    bass: {
      name: "ë‚®ì€ìŒìë¦¬í‘œ",
      cIndex: 3,   // C3 index
      baseOct: 3,
      staffIndexToY(i){ const top=150,gap=18; const bottom=top+4*gap; return bottom - i*(gap/2); },
      ranges: {
        inter:      { min:  3, max: 10 },
        advanced:   { min:  0, max:  8 },
        expert:     { min:  0, max:  8 },
        masterLow:  { min: -6, max: -1 },
        masterHigh: { min:  9, max: 16 },
      }
    }
  };

  const MODES = {
    beginner: { label: "ì´ˆê¸‰", seconds: 30, clefs:['treble'], rangeKeys:['beginner'], gen(){ return genInRange('treble','beginner'); } },
    inter:    { label: "ì¤‘ê¸‰", seconds: 25, clefs:['bass'],   rangeKeys:['inter'],    gen(){ return genInRange('bass','inter'); } },
    advanced: { label: "ê³ ê¸‰", seconds: 30, clefs:['treble','bass'], rangeKeys:['advanced'], gen(){ const c=Math.random()<0.5?'treble':'bass'; return genInRange(c,'advanced'); } },
    expert:   { label: "ì „ë¬¸ê°€", seconds: 30, clefs:['treble','bass'], rangeKeys:['expert'],   gen(){ const c=Math.random()<0.5?'treble':'bass'; return genInRange(c,'expert'); } },
    master:   { label: "ë§ˆìŠ¤í„°", seconds: 30, clefs:['treble','bass'], rangeKeys:['masterLow','masterHigh'], gen(){ const c=Math.random()<0.5?'treble':'bass'; const z=Math.random()<0.5?'masterLow':'masterHigh'; return genInRange(c,z); } },
  };

  // ===== DOM =====
  const svg = document.getElementById('staff');
  const answersBox = document.getElementById('answers');
  const qIndex = document.getElementById('qIndex');
  const correctEl = document.getElementById('correct');
  const timerEl = document.getElementById('timer');

  // ===== ìƒíƒœ =====
  const state = { mode:'beginner', branch:'ë§¤ê³¡ì ', player:'', q:0, correct:0, bonus:0, current:null, timerId:null, tLeft:0 };

  // ===== ìœ í‹¸ =====
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min }
  function mod(n,m){ return ((n%m)+m)%m }
  function nowMonthKey(d=new Date()){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
  function getMonthKeyFromISO(iso){ const d = new Date(iso); return nowMonthKey(d); }

  // ì˜¥íƒ€ë¸Œ ì ‘ë‘ì–´
  function octavePrefix(o){ if(o<=2) return 'ë” ë‚®ì€'; if(o===3) return 'ë‚®ì€'; if(o===4) return 'ê°€ì˜¨'; return 'ë†’ì€'; }

  // ===== ê³„ì´ë¦„ ì‚°ì¶œ (ì˜ˆì™¸ ì—†ëŠ” ì •í™•í•œ ê³„ì‚°) =====
  function noteInfo(clefKey, staffIndex){
    const c = CLEF[clefKey];
    const di = staffIndex - c.cIndex;         // ê¸°ì¤€ Cë¡œë¶€í„°ì˜ 7ìŒê³„ ì˜¤í”„ì…‹
    const letterIndex = mod(di,7);             // 0=C(ë„) .. 6=B(ì‹œ)
    const octave = c.baseOct + Math.floor(di/7);
    const name = NOTE_NAMES[letterIndex];
    const label = `${octavePrefix(octave)} ${name}`;
    return { name, octave, label };
  }

  // ===== ì¶œì œ =====
  function genInRange(clefKey, rangeKey){
    const clef = CLEF[clefKey];
    const r = clef.ranges[rangeKey];
    const idx = randInt(r.min, r.max);
    const info = noteInfo(clefKey, idx);
    return { clef: clefKey, staffIndex: idx, name: info.label };
  }

  // ===== ë³´ê¸° í’€ ìƒì„±(ëª¨ë“œë³„ ì „ì²´ ê°€ëŠ¥í•œ ë¼ë²¨) =====
  function allAnswerLabelsForMode(modeKey){
    const m = MODES[modeKey];
    const set = new Set();
    m.clefs.forEach(clefKey=>{
      m.rangeKeys.forEach(rk=>{
        const r = CLEF[clefKey].ranges[rk];
        for(let i=r.min; i<=r.max; i++){
          const info = noteInfo(clefKey, i);
          set.add(info.label);
        }
      });
    });
    return Array.from(set);
  }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  // ===== SVG ë Œë” =====
  function drawStaffFrame(){
    svg.innerHTML='';
    const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
    bg.setAttribute('x',0); bg.setAttribute('y',0); bg.setAttribute('width',800); bg.setAttribute('height',450);
    bg.setAttribute('rx',18); bg.setAttribute('fill','#0b1230');
    svg.appendChild(bg);

    const title = document.createElementNS('http://www.w3.org/2000/svg','text');
    title.setAttribute('x',400); title.setAttribute('y',60); title.setAttribute('text-anchor','middle');
    title.setAttribute('fill','#e9ecf5'); title.setAttribute('font-size','22'); title.setAttribute('font-weight','800');
    title.textContent = 'ì´ ìŒí‘œì˜ ê³„ì´ë¦„ì€ ë¬´ì—‡ì¼ê¹Œìš”?';
    svg.appendChild(title);

    const top = 150, gap = 18;
    for(let i=0;i<5;i++){
      const y = top + i*gap;
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1',120); line.setAttribute('x2',680); line.setAttribute('y1',y); line.setAttribute('y2',y);
      line.setAttribute('stroke','#334'); line.setAttribute('stroke-width','2');
      svg.appendChild(line);
    }
  }

  function drawClefSymbol(clefKey){
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x',100); t.setAttribute('y',200); t.setAttribute('fill','#e9ecf5');
    t.setAttribute('font-size','96'); t.setAttribute('font-family',"'Noto Music','Segoe UI Symbol',serif");
    // ğ„ (U+1D11E), ğ„¢ (U+1D122)
    t.textContent = clefKey==='treble' ? 'ğ„' : 'ğ„¢';
    svg.appendChild(t);
  }

  function staffIndexToY(clefKey, i){ return CLEF[clefKey].staffIndexToY(i); }

  // ë§ì¤„ ê°„ê²©=ì˜¤ì„  ì¹¸ ê°„ê²©(gap/2), í‘œì‹œ ê·œì¹™ ë°˜ì˜
  function drawNote(clefKey, staffIndex){
    const x = 420; 
    const y = staffIndexToY(clefKey, staffIndex);

    const note = document.createElementNS('http://www.w3.org/2000/svg','ellipse');
    note.setAttribute('cx', x); note.setAttribute('cy', y); note.setAttribute('rx', 16); note.setAttribute('ry', 12);
    note.setAttribute('fill','#e9ecf5'); note.setAttribute('stroke','#111'); note.setAttribute('stroke-width','2');
    svg.appendChild(note);

    // through=true: ì˜¨ìŒí‘œ ì •ì¤‘ì•™ì„ ë§ì¤„ì´ ì§€ë‚˜ê° / false: ìŒí‘œì™€ ê²¹ì¹˜ì§€ ì•Šê²Œ ë”± ë¶™ê²Œ(ì¡°ê¸ˆ ì§§ê²Œ)
    function addLedger(ly, through=false){
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      const pad = through ? 30 : 26;
      line.setAttribute('x1', x-pad); line.setAttribute('x2', x+pad); line.setAttribute('y1', ly); line.setAttribute('y2', ly);
      line.setAttribute('stroke','#556'); line.setAttribute('stroke-width','2');
      svg.appendChild(line);
    }

    if(staffIndex < 0){
      if(staffIndex === -1) return; // ì²« ì•„ë˜ì¹¸: ë§ì¤„ X
      if(staffIndex === -2){ addLedger(staffIndexToY(clefKey,-2), true); return; }  // ì²« ì•„ë«ë§ì¤„: ì¤‘ì•™ í†µê³¼
      if(staffIndex === -3){ addLedger(staffIndexToY(clefKey,-2), false); return; } // ë‘ë²ˆì§¸ ì•„ë˜ì¹¸: ì•ˆìª½ ë§ì¤„ë§Œ
      for(let i=-2;i>=staffIndex;i--){
        if(i%2===0){ addLedger(staffIndexToY(clefKey,i), true); }      // ë§ì¤„ ìœ„(ì§ìˆ˜): ì¤‘ì•™ í†µê³¼
        else       { addLedger(staffIndexToY(clefKey,i+1), false); i--; } // ì¹¸(í™€ìˆ˜): ì¸ì ‘ ë§ì¤„ë§Œ
      }
    } else if(staffIndex > 8){
      if(staffIndex === 9) return; // ì²« ìœ„ì¹¸: ë§ì¤„ X
      if(staffIndex === 10){ addLedger(staffIndexToY(clefKey,10), true); return; }  // ì²« ìœ—ë§ì¤„: ì¤‘ì•™ í†µê³¼
      if(staffIndex === 11){ addLedger(staffIndexToY(clefKey,10), false); return; } // ë‘ë²ˆì§¸ ìœ„ì¹¸: ì•ˆìª½ ë§ì¤„ë§Œ
      for(let i=10;i<=staffIndex;i++){
        if(i%2===0){ addLedger(staffIndexToY(clefKey,i), true); }       // ë§ì¤„ ìœ„(ì§ìˆ˜): ì¤‘ì•™ í†µê³¼
        else       { addLedger(staffIndexToY(clefKey,i-1), false); i++; } // ì¹¸(í™€ìˆ˜): ì¸ì ‘ ë§ì¤„ë§Œ
      }
    }
  }

  function renderProblem(prob){
    drawStaffFrame();
    drawClefSymbol(prob.clef);
    drawNote(prob.clef, prob.staffIndex);
    const label = document.createElementNS('http://www.w3.org/2000/svg','text');
    label.setAttribute('x',720); label.setAttribute('y',60); label.setAttribute('fill','#aab3d3'); label.setAttribute('font-size','14'); label.setAttribute('text-anchor','end');
    label.textContent = `ë¬¸ì œ ${state.q+1} / 10`;
    svg.appendChild(label);
  }

  // ===== 8ì§€ ë³´ê¸° ìƒì„± (ì´ˆê¸‰/ì¤‘ê¸‰) ë˜ëŠ” 7ì§€ ë³´ê¸° (ê³ ê¸‰ ì´ìƒ) =====
  function makeAnswerButtons(prob){
    answersBox.innerHTML='';
    const correct = prob.name;                      // "ê°€ì˜¨ ë„" ë“±
    
    let options;
    
    if (state.mode === 'beginner') {
      // ì´ˆê¸‰: ê°€ì˜¨ë„~ë†’ì€ë„ ìˆœì„œë¡œ ê³ ì •ëœ 8ê°œ ë‹µì§€
      options = generateFixedBeginnerAnswers(correct);
    } else if (state.mode === 'inter') {
      // ì¤‘ê¸‰: ë‚®ì€ë„~ê°€ì˜¨ë„ ìˆœì„œë¡œ ê³ ì •ëœ 8ê°œ ë‹µì§€
      options = generateFixedIntermediateAnswers(correct);
    } else {
      // ê³ ê¸‰ ì´ìƒ: 7ê°œ ë‹µì§€ (ì •ë‹µ 1ê°œ + ì˜¤ë‹µ 6ê°œ)
      const pool = allAnswerLabelsForMode(state.mode).filter(x => x !== correct);
      shuffle(pool);
      const distractors = pool.slice(0, 6);         // ì˜¤ë‹µ 6ê°œ
      options = shuffle([correct, ...distractors]); // ì´ 7ê°œ, ëœë¤ ìˆœì„œ
    }

    const row = document.createElement('div');
    row.className = 'grid-answers';
    options.forEach(label=>{
      const b = document.createElement('button');
      b.className = 'ans';
      b.textContent = label;
      b.onclick = ()=> onAnswer(label);
      row.appendChild(b);
    });
    answersBox.appendChild(row);
  }



  // ì´ˆê¸‰ìš© ê³ ì • ë‹µì§€ ìƒì„± (ê°€ì˜¨ë„~ë†’ì€ë„ ìˆœì„œ)
  function generateFixedBeginnerAnswers(correctAnswer) {
    const fixedOrder = [
      'ê°€ì˜¨ ë„', 'ê°€ì˜¨ ë ˆ', 'ê°€ì˜¨ ë¯¸', 'ê°€ì˜¨ íŒŒ', 'ê°€ì˜¨ ì†”', 'ê°€ì˜¨ ë¼', 'ê°€ì˜¨ ì‹œ',
      'ë†’ì€ ë„'
    ];
    
    // ì •ë‹µì´ ê³ ì • ìˆœì„œì— í¬í•¨ë˜ì–´ ìˆì§€ ì•Šë‹¤ë©´, ì²« ë²ˆì§¸ ìœ„ì¹˜ì— ì •ë‹µì„ ë„£ê³  ë§ˆì§€ë§‰ í•˜ë‚˜ ì œê±°
    if (!fixedOrder.includes(correctAnswer)) {
      return [correctAnswer, ...fixedOrder.slice(0, 7)];
    }
    
    return fixedOrder;
  }

  // ì¤‘ê¸‰ìš© ê³ ì • ë‹µì§€ ìƒì„± (ë‚®ì€ë„~ê°€ì˜¨ë„ ìˆœì„œ)
  function generateFixedIntermediateAnswers(correctAnswer) {
    const fixedOrder = [
      'ë‚®ì€ ë„', 'ë‚®ì€ ë ˆ', 'ë‚®ì€ ë¯¸', 'ë‚®ì€ íŒŒ', 'ë‚®ì€ ì†”', 'ë‚®ì€ ë¼', 'ë‚®ì€ ì‹œ',
      'ê°€ì˜¨ ë„'
    ];
    
    // ì •ë‹µì´ ê³ ì • ìˆœì„œì— í¬í•¨ë˜ì–´ ìˆì§€ ì•Šë‹¤ë©´, ì²« ë²ˆì§¸ ìœ„ì¹˜ì— ì •ë‹µì„ ë„£ê³  ë§ˆì§€ë§‰ í•˜ë‚˜ ì œê±°
    if (!fixedOrder.includes(correctAnswer)) {
      return [correctAnswer, ...fixedOrder.slice(0, 7)];
    }
    
    return fixedOrder;
  }

  function speak(text){
    if(!document.getElementById('ttsToggle').checked) return;
    const synth = window.speechSynthesis; if(!synth) return;
    const ut = new SpeechSynthesisUtterance(text);
    ut.lang = 'ko-KR'; ut.rate = 1.0; ut.pitch=1.0;
    synth.cancel(); synth.speak(ut);
  }

  // ===== ê²Œì„ íë¦„ =====
  function nextQuestion(){
    console.log('nextQuestion called, q:', state.q);
    if(state.q>=10){ 
      console.log('Game completed! Calling endGame...');
      endGame(); 
      return; 
    }
    const prob = MODES[state.mode].gen();
    state.current = prob;
    renderProblem(prob);
    makeAnswerButtons(prob);          // â† ë§¤ ë¬¸ì œ 7ì§€ ë³´ê¸° í‘œì‹œ
    qIndex.textContent = String(state.q+1);
  }

  function onAnswer(ans){
    const correctName = state.current.name; // ì˜ˆ: "ê°€ì˜¨ ë„"
    const btns = [...document.querySelectorAll('.ans')];
    btns.forEach(b=> b.disabled=true);
    const picked = btns.find(b=> b.textContent===ans);
    const isCorrect = (ans===correctName);
    if(isCorrect){ state.correct++; speak('ì •ë‹µ! '+ans); picked?.classList.add('correct'); }
    else { speak('ì•„ì‰¬ì›Œìš”. ì •ë‹µì€ '+(correctName||'ì •ë‹µì—†ìŒ')); picked?.classList.add('wrong'); }
    correctEl.textContent = state.correct;
    setTimeout(()=>{ btns.forEach(b=> b.disabled=false); state.q++; nextQuestion(); }, 600);
  }

  function startTimer(){
    clearInterval(state.timerId);
    const total = MODES[state.mode].seconds;
    state.tLeft = total;
    timerEl.textContent = total.toFixed(1);
    const start = performance.now();
    state.timerId = setInterval(()=>{
      const elapsed = (performance.now()-start)/1000;
      const left = Math.max(0, total - elapsed);
      state.tLeft = left; timerEl.textContent = left.toFixed(1);
      if(left<=0){ clearInterval(state.timerId); endGame(); }
    }, 100);
  }

  function startGame(mode){
    state.mode = mode;
    state.branch = document.getElementById('branch').value;
    state.player = document.getElementById('player').value.trim() || 'ë¬´ëª…';
    state.q=0; state.correct=0; state.bonus=0; state.current=null;

    document.getElementById('hudBranch').textContent = 'ì§€ì : '+state.branch;
    document.getElementById('hudPlayer').textContent = 'ì´ë¦„: '+state.player;
    document.getElementById('hudMode').textContent = 'ëª¨ë“œ: '+MODES[state.mode].label;

    document.getElementById('intro').classList.add('hidden');
    document.getElementById('mode').classList.add('hidden');
    document.getElementById('result').classList.add('hidden');
    document.getElementById('game').classList.remove('hidden');

    drawStaffFrame(); startTimer(); nextQuestion(); // ë³´ê¸° ìƒì„±ì€ nextQuestion ë‚´ë¶€ì—ì„œ
  }

  function endGame(){
    console.log('endGame called!', {q: state.q, correct: state.correct, bonus: state.tLeft});
    clearInterval(state.timerId);
    const bonus = Math.round(state.tLeft*2);
    const score = state.correct*10 + bonus;
    state.bonus = bonus;
    const rec = {date:new Date().toISOString(), branch:state.branch, player:state.player, mode:MODES[state.mode].label, correct:state.correct, bonus, score};
    console.log('Game record:', rec);
    saveScore(rec);
    fillResult(rec);
    document.getElementById('game').classList.add('hidden');
    document.getElementById('result').classList.remove('hidden');
    console.log('Result screen should be visible now');
  }

  // ê²°ê³¼ í™”ë©´ ì±„ìš°ê¸°
  function fillResult(rec){
    console.log('fillResult called with:', rec);
    try {
      document.getElementById('rBranch').textContent = rec.branch;
      document.getElementById('rPlayer').textContent = rec.player;
      document.getElementById('rMode').textContent = rec.mode;
      document.getElementById('rCorrect').textContent = rec.correct;
      document.getElementById('rBonus').textContent = `+${rec.bonus}`;
      document.getElementById('rScore').textContent = rec.score;
      console.log('Result screen filled successfully');
    } catch (error) {
      console.error('Error filling result screen:', error);
    }
  }

  // ===== ê¸°ë¡/ë­í‚¹ (localStorage) + ê´€ë¦¬ì =====
  const KEY='sella_note_quiz_scores_v3';
  const LAST_RESET_KEY='sella_note_quiz_last_reset_month';
  const ADMIN_PIN='0000';
  let isAdmin=false;
  function withAdmin(action){ if(isAdmin){ action(); return; } const pin=prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸(4ìë¦¬)ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); if(pin===null) return; if(pin===ADMIN_PIN){ isAdmin=true; action(); } else alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }

  function loadScores(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch(e){ return []; } }
  function saveScore(s){ const arr = loadScores(); arr.unshift(s); localStorage.setItem(KEY, JSON.stringify(arr.slice(0,500))); renderScores(); renderMonthlyBoard(); }

  function renderScores(){
    const arr = loadScores();
    const tbody = document.querySelector('#tableScores tbody');
    if(!tbody) return;
    tbody.innerHTML='';
    arr.slice(0,20).forEach(r=>{
      const d = new Date(r.date);
      const ds = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${ds}</td><td>${r.branch}</td><td>${r.player}</td><td>${r.mode}</td><td>${r.correct}</td><td>${r.score}</td><td>+${r.bonus}</td>`;
      tbody.appendChild(tr);
    })
  }

  function renderMonthlyBoard(){
    const monthEl = document.getElementById('monthPicker');
    const branchEl = document.getElementById('rankBranch');
    if(!monthEl) return;
    const monthKey = monthEl.value || nowMonthKey();
    const branchFilter = branchEl.value || 'ALL';

    const arr = loadScores().filter(r => getMonthKeyFromISO(r.date) === monthKey);
    const filtered = branchFilter==='ALL' ? arr : arr.filter(r=> r.branch === branchFilter);

    const map = new Map();
    filtered.forEach(r=>{
      const key = `${r.branch}|${r.player}`;
      if(!map.has(key)){ map.set(key, {branch:r.branch, player:r.player, best:r.score, rounds:1}); }
      else{ const g = map.get(key); g.best = Math.max(g.best, r.score); g.rounds += 1; }
    });

    const rows = [...map.values()].sort((a,b)=> b.best - a.best).slice(0,20);
    const tbody = document.querySelector('#monthlyBoard tbody');
    if(!tbody) return;
    tbody.innerHTML='';
    rows.forEach((g,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${g.branch}</td><td>${g.player}</td><td>${g.best}</td><td>${g.rounds}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ë¦¬ì…‹
  function resetMonthData(monthKey){ const arr = loadScores(); const next = arr.filter(r => getMonthKeyFromISO(r.date) !== monthKey); localStorage.setItem(KEY, JSON.stringify(next)); localStorage.setItem(LAST_RESET_KEY, monthKey); renderScores(); renderMonthlyBoard(); }
  function resetMonthAll(){ const monthEl=document.getElementById('monthPicker'); const monthKey = monthEl.value || nowMonthKey(); resetMonthData(monthKey); alert(`${monthKey} ì›” ê¸°ë¡ì´ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`); }
  function resetMonthBranch(){ const monthEl=document.getElementById('monthPicker'); const branchEl=document.getElementById('rankBranch'); const monthKey=monthEl.value || nowMonthKey(); const branch=branchEl.value; if(branch==='ALL'){ alert('ì§€ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”. (ì›” ì „ì²´ ë¦¬ì…‹ì€ ì¢Œì¸¡ ë²„íŠ¼ ì‚¬ìš©)'); return; } const arr=loadScores(); const next=arr.filter(r=> !(getMonthKeyFromISO(r.date)===monthKey && r.branch===branch)); localStorage.setItem(KEY, JSON.stringify(next)); renderScores(); renderMonthlyBoard(); alert(`${monthKey} ì›” ${branch} ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`); }

  // ìë™ ë¦¬ì…‹ ìŠ¤ì¼€ì¤„ëŸ¬ (ë§¤ì›” 1ì¼ 00:00)
  function scheduleNextMonthlyReset(){
    const now=new Date(); const y=now.getFullYear(); const m=now.getMonth();
    const next=(m===11)? new Date(y+1,0,1,0,0,0,0) : new Date(y,m+1,1,0,0,0,0);
    const ms=next-now;
    setTimeout(()=>{
      const currentMonth = nowMonthKey(new Date());
      resetMonthData(currentMonth);
      scheduleNextMonthlyReset();
    }, ms);
  }
  function ensureMonthlyResetOnStartup(){
    const current=nowMonthKey();
    const last=localStorage.getItem(LAST_RESET_KEY);
    if(last!==current){ resetMonthData(current); }
  }

  // ===== í™”ë©´ ì „í™˜ í•¨ìˆ˜ =====
  function showIntro() {
    document.getElementById('intro').classList.remove('hidden');
    document.getElementById('mode').classList.add('hidden');
    document.getElementById('game').classList.add('hidden');
    document.getElementById('result').classList.add('hidden');
    document.getElementById('scores').classList.add('hidden');
    renderScores();
    renderMonthlyBoard();
  }
  

  
  function showMode() {
    // ì‚¬ìš©ì ì •ë³´ ê²€ì¦
    const branch = document.getElementById('branch').value;
    const player = document.getElementById('player').value.trim();
    
    if (!player) {
      alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    document.getElementById('intro').classList.add('hidden');
    document.getElementById('mode').classList.remove('hidden');
    document.getElementById('game').classList.add('hidden');
    document.getElementById('result').classList.add('hidden');
    document.getElementById('scores').classList.add('hidden');
  }
  
  function selectMode(mode) {
    startGame(mode);
  }
  
  function showScores() {
    document.getElementById('intro').classList.add('hidden');
    document.getElementById('mode').classList.add('hidden');
    document.getElementById('game').classList.add('hidden');
    document.getElementById('result').classList.add('hidden');
    document.getElementById('scores').classList.remove('hidden');
    renderScores();
    renderMonthlyBoard();
  }

  // ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© =====
  function bindEvents() {
    // ë©”ì¸ í™”ë©´ ì´ë™
    document.getElementById('goMode').onclick = () => showMode();
    document.getElementById('showScores').onclick = () => showScores();
    
    // ê²Œì„ ëª¨ë“œ í™”ë©´ ì´ë™
    document.getElementById('backToIntro').onclick = () => showIntro();
    document.getElementById('toMode').onclick = () => showMode();
    document.getElementById('toIntro').onclick = () => showIntro();
    
    // ì ìˆ˜ ë³´ê¸° í™”ë©´ì—ì„œ ëŒì•„ê°€ê¸°
    document.getElementById('backToIntroFromScores').onclick = () => showIntro();
    document.getElementById('backToModeFromScores').onclick = () => showMode();
    
    // ê²Œì„ í™”ë©´ ì»¨íŠ¸ë¡¤
    document.getElementById('btnQuit').onclick=()=>{ clearInterval(state.timerId); showIntro(); };
    document.getElementById('btnSkip').onclick=()=>{ state.q++; nextQuestion(); };
    document.getElementById('again').onclick=()=> startGame(state.mode);
    
    // ê²Œì„ ëª¨ë“œ ë²„íŠ¼ë“¤ì— ëŒ€í•œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    document.querySelectorAll('.mode').forEach(btn => {
      btn.addEventListener('click', () => startGame(btn.dataset.mode));
    });
  }

  // CSV ë‚´ë³´ë‚´ê¸°
  document.getElementById('exportCsv').onclick = () => {
    const arr = loadScores();
    const header = ['date','branch','player','mode','correct','bonus','score'];
    const esc = (v) => `"${String(v).replace(/"/g, '""')}"`;
    const lines = [ header.join(','), ...arr.map(r => header.map(h => esc(r[h])).join(',')) ];
    const blob = new Blob(["\uFEFF" + lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = '153sella_note_quiz_scores.csv'; a.click();
    URL.revokeObjectURL(url);
  };

  document.getElementById('clearLocal').onclick=()=> withAdmin(()=>{ localStorage.removeItem(KEY); renderScores(); renderMonthlyBoard(); alert('ì „ì²´ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); });
  document.getElementById('resetMonth').onclick = ()=> withAdmin(resetMonthAll);
  document.getElementById('resetMonthBranch').onclick = ()=> withAdmin(resetMonthBranch);
  document.getElementById('monthPicker').onchange = renderMonthlyBoard;
  document.getElementById('rankBranch').onchange = renderMonthlyBoard;



  // ì´ˆê¸°í™”
  (function init(){
    const m=nowMonthKey();
    const monthEl=document.getElementById('monthPicker');
    if(monthEl) monthEl.value=m;
    renderScores(); renderMonthlyBoard(); drawStaffFrame();
    ensureMonthlyResetOnStartup();
    scheduleNextMonthlyReset();
    window.addEventListener('focus', ensureMonthlyResetOnStartup);
    
    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    bindEvents();
    
    // TTS í•­ìƒ ì²´í¬
    const ttsToggle = document.getElementById('ttsToggle');
    if(ttsToggle) ttsToggle.checked = true;
    
    // ê²Œì„ ëª¨ë“œ ë²„íŠ¼ë“¤ì— ëŒ€í•œ ì´ë²¤íŠ¸ ë°”ì¸ë”©ì„ ë‹¤ì‹œ í•œë²ˆ í™•ì‹¤í•˜ê²Œ
    setTimeout(() => {
      const modeButtons = document.querySelectorAll('.mode');
      console.log('Found mode buttons:', modeButtons.length);
      modeButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('Mode button clicked:', btn.dataset.mode);
          startGame(btn.dataset.mode);
        });
      });
    }, 200);
    
    // ì²«í™”ë©´ë¶€í„° ì‹œì‘
    showIntro();
  })();
  </script>
</body>
</html>
